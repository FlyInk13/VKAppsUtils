{"version":3,"sources":["../src/PromiseAPI.js"],"names":["PromiseAPI","method","params","Promise","resolve","reject","request_id","Math","random","toString","data","access_token","v","requests","cartCheck","error","apiError","error_reason","errorCode","error_code","cartInit","callMethod","showCaptcha","error_data","response","view","cart","log","pause","subscribe","bridge","detail","type","parseError","parseResponse","request","send","console","ignoreCart","interval","sendRequest","debug","push","length","clearInterval","shift","setInterval","cartTick","oldPopout","state","popout","setState","title","autoclose","captchaCode","captcha_img","width","borderRadius","e","currentTarget","value","then","captcha_key","captcha_sid","bind"],"mappings":"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","sourcesContent":["import React from 'react';\nimport Alert from '@vkontakte/vkui/dist/components/Alert/Alert';\nimport Input from '@vkontakte/vkui/dist/components/Input/Input';\nimport bridge from \"@vkontakte/vk-bridge\";\n\nclass PromiseAPI {\n  constructor() {\n    // user data\n    this.access_token = false;\n    this.view = false;\n    this.v = 5.92;\n\n    // requests map { request_id: request_data };\n    this.requests = {};\n    // requests cart [request_id, request_id, ...];\n    this.cart = [];\n\n    // internal vars\n    this.log = false;\n    this.pause = false;\n\n    // bridge transport\n    this.subscribe();\n  }\n\n  subscribe() {\n    this.bridge = bridge;\n    this.bridge.subscribe(({ detail: { type, data }}) => {\n      switch (type) {\n        case 'VKWebAppCallAPIMethodFailed':\n          this.parseError(data);\n          break;\n        case 'VKWebAppCallAPIMethodResult':\n          this.parseResponse(data);\n          break;\n      }\n    });\n  }\n\n  sendRequest(request) {\n    this.bridge.send('VKWebAppCallAPIMethod', request.data);\n  }\n\n  debug(...args) {\n    if (!this.log) return;\n    console.log(...args);\n  }\n\n  cartCheck(request_id, ignoreCart) {\n    if (!this.pause && (!this.interval || ignoreCart)) {\n      const request = this.requests[request_id];\n      this.sendRequest(request);\n      this.debug('cartCheck', 'call', request);\n      return;\n    }\n    this.debug('cartCheck', 'push');\n    this.cart.push(request_id);\n  }\n\n  cartTick() {\n    this.debug('cartTick', this.cart.length);\n    if (!this.cart.length) {\n      clearInterval(this.interval);\n      delete this.interval;\n      return;\n    }\n    const request_id = this.cart.shift();\n    this.cartCheck(request_id, true);\n  }\n\n  cartInit() {\n    this.debug('cartInit');\n    if (this.interval) return;\n    this.interval = setInterval(() => this.cartTick(), 334);\n  }\n\n  showCaptcha(method, params, error) {\n    if (!this.view) {\n      throw error;\n    }\n\n    this.pause = 1;\n    return new Promise((resolve) => {\n      const view = this.view;\n      const oldPopout = view.state.popout;\n      view.setState({\n        popout: (\n          <Alert\n            actionsLayout=\"vertical\"\n            actions={[\n              {\n                title: 'OK',\n                autoclose: true,\n              }\n            ]}\n            onClose={() => {\n              resolve(view.state.captchaCode);\n              view.setState({ popout: oldPopout, captchaCode: null });\n            }}\n          >\n            <h2>Введите код с картинки</h2>\n            <img src={error.captcha_img} style={{ width: 238, borderRadius: 3 }} alt={error.captcha_img}/>\n            <Input defaultValue='' onChange={(e) => {\n              const captchaCode = e.currentTarget.value;\n              view.setState({ captchaCode });\n            }}/>\n          </Alert>\n        )\n      });\n    }).then((captcha_key) => {\n      this.pause = 0;\n      const captcha_sid = error.captcha_sid;\n      return this.callMethod(method, {\n        ...params,\n        captcha_key,\n        captcha_sid,\n      });\n    });\n  }\n\n  getMethod(method) {\n    return this.callMethod.bind(this, method);\n  }\n\n  callMethod = (method, params = {}) => {\n    return new Promise((resolve, reject) => {\n      const request_id = (Math.random() * 1e20).toString(32);\n      const data = {\n        method,\n        params: {\n          access_token: this.access_token,\n          v: this.v,\n          ...params,\n        },\n        request_id,\n      };\n\n      this.requests[request_id] = { resolve, reject, data };\n      this.cartCheck(request_id);\n    }).catch((error) => {\n      error = error || {};\n      const apiError = error.error_reason || error;\n      const errorCode = apiError.error_code || 0;\n\n      switch (errorCode) {\n        case 6:\n          this.cartInit();\n          return this.callMethod(method, params);\n        case 14:\n          return this.showCaptcha(method, params, apiError);\n      }\n\n      throw apiError;\n    });\n  };\n\n  parseError = (data) => {\n    const { error_data, request_id } = data;\n    if (!this.requests[request_id]) return;\n    this.requests[request_id].reject(error_data);\n    delete this.requests[request_id];\n  };\n\n  parseResponse = (data) => {\n    const { response, request_id } = data;\n    if (!this.requests[request_id]) return;\n    this.requests[request_id].resolve(response);\n    delete this.requests[request_id];\n  };\n}\n\nexport default PromiseAPI;\n"],"file":"PromiseAPI.js"}