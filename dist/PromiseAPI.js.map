{"version":3,"sources":["../src/PromiseAPI.js"],"names":["PromiseAPI","method","params","Promise","resolve","reject","request_id","Math","random","toString","data","access_token","v","requests","cartCheck","error","apiError","error_reason","errorCode","error_code","cartInit","callMethod","showCaptcha","error_data","response","connect","view","cart","log","pause","subscribe","e","detail","type","parseError","parseResponse","console","ignoreCart","interval","request","send","debug","push","length","clearInterval","shift","setInterval","cartTick","oldPopout","state","popout","setState","title","autoclose","captchaCode","captcha_img","width","borderRadius","currentTarget","value","then","captcha_key","captcha_sid","bind"],"mappings":"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","sourcesContent":["import React from 'react';\nimport Alert from '@vkontakte/vkui/dist/components/Alert/Alert';\nimport Input from '@vkontakte/vkui/dist/components/Input/Input';\nimport connect from '@vkontakte/vk-connect';\n\nclass PromiseAPI {\n  constructor() {\n    this.connect  = connect;\n    this.requests = {};\n    this.access_token = false;\n    this.view = false;\n    this.v = 5.92;\n    this.cart = [];\n    this.log = false;\n    this.pause = false;\n\n    this.connect.subscribe((e) => {\n      switch (e.detail.type) {\n        case 'VKWebAppCallAPIMethodFailed':\n          this.parseError(e.detail.data);\n          break;\n        case 'VKWebAppCallAPIMethodResult':\n          this.parseResponse(e.detail.data);\n          break;\n      }\n    });\n  }\n\n  debug(...args) {\n    if (!this.log) return;\n    console.log(...args);\n  }\n\n  cartCheck(request_id, ignoreCart) {\n    if (!this.pause && (!this.interval || ignoreCart)) {\n      const request = this.requests[request_id];\n      this.connect.send('VKWebAppCallAPIMethod', request.data);\n      this.debug('cartCheck', 'call', request);\n      return;\n    }\n    this.debug('cartCheck', 'push');\n    this.cart.push(request_id);\n  }\n\n  cartTick() {\n    this.debug('cartTick', this.cart.length);\n    if (!this.cart.length) {\n      clearInterval(this.interval);\n      delete this.interval;\n      return;\n    }\n    const request_id = this.cart.shift();\n    this.cartCheck(request_id, true);\n  }\n\n  cartInit() {\n    this.debug('cartInit');\n    if (this.interval) return;\n    this.interval = setInterval(() => this.cartTick(), 334);\n  }\n\n  showCaptcha(method, params, error) {\n    if (!this.view) {\n      throw error;\n    }\n\n    this.pause = 1;\n    return new Promise((resolve) => {\n      const view = this.view;\n      const oldPopout = view.state.popout;\n      view.setState({\n        popout: (\n          <Alert\n        actionsLayout=\"vertical\"\n        actions={[{\n            title: 'OK',\n            autoclose: true,\n          }]}\n        onClose={() => {\n        resolve(view.state.captchaCode);\n        view.setState({ popout: oldPopout, captchaCode: null });\n      }}\n    >\n    <h2>Введите код с картинки</h2>\n      <img src={error.captcha_img} style={{ width: 238, borderRadius: 3 }} alt={error.captcha_img} />\n      <Input defaultValue='' onChange={(e) => {\n        const captchaCode = e.currentTarget.value;\n        view.setState({ captchaCode });\n      }}/>\n      </Alert>\n    )\n    });\n    }).then((captcha_key) => {\n      this.pause = 0;\n      const captcha_sid = error.captcha_sid;\n      return this.callMethod(method, {\n        ...params,\n        captcha_key,\n        captcha_sid,\n      });\n    });\n  }\n\n  getMethod(method) {\n    return this.callMethod.bind(this, method);\n  }\n\n  callMethod = (method, params = {}) => {\n    return new Promise((resolve, reject) => {\n      const request_id = (Math.random() * 1e20).toString(32);\n      const data = {\n        method,\n        params: {\n          access_token: this.access_token,\n          v: this.v,\n          ...params,\n        },\n        request_id,\n      };\n\n      this.requests[request_id] = {resolve, reject, data};\n      this.cartCheck(request_id);\n    }).catch((error) => {\n      error = error || {};\n      const apiError = error.error_reason || error;\n      const errorCode = apiError.error_code || 0;\n\n      switch (errorCode) {\n        case 6:\n          this.cartInit();\n          return this.callMethod(method, params);\n        case 14:\n          return this.showCaptcha(method, params, apiError);\n      }\n\n      throw apiError;\n    });\n  };\n\n  parseError = (data) => {\n    const {error_data, request_id} = data;\n    if (!this.requests[request_id]) return;\n    this.requests[request_id].reject(error_data);\n    delete this.requests[request_id];\n  };\n\n  parseResponse = (data) => {\n    const {response, request_id} = data;\n    if (!this.requests[request_id]) return;\n    this.requests[request_id].resolve(response);\n    delete this.requests[request_id];\n  };\n}\n\nexport default PromiseAPI;\n"],"file":"PromiseAPI.js"}