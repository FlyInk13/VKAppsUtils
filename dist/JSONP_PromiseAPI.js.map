{"version":3,"sources":["../src/JSONP_PromiseAPI.js"],"names":["JSONP_PromiseAPI","method","params","Promise","resolve","reject","request_id","Math","random","toString","data","access_token","v","requests","cartCheck","error","apiError","error_reason","errorCode","error_code","cartInit","callMethod","showCaptcha","error_data","response","view","cart","log","pause","subscribe","window","apiCallback","console","ignoreCart","interval","request","sendRequest","debug","push","length","clearInterval","shift","setInterval","cartTick","oldPopout","state","popout","captcha_img","setState","title","autoclose","captchaCode","width","borderRadius","e","currentTarget","value","then","captcha_key","captcha_sid","callback_name","parseError","parseResponse","document","getElementById","outerHTML","script","createElement","src","callback","Object","entries","forEach","key","encodeURIComponent","String","id","onerror","head","appendChild","replace","bind","sendJSON"],"mappings":"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","sourcesContent":["import { Input, Alert } from '@vkontakte/vkui';\nimport React from \"react\";\n\nclass JSONP_PromiseAPI {\n  constructor() {\n    // user data\n    this.access_token = false;\n    this.view = false;\n    this.v = 5.92;\n\n    // requests map { request_id: request_data };\n    this.requests = {};\n    // requests cart [request_id, request_id, ...];\n    this.cart = [];\n\n    // internal vars\n    this.log = false;\n    this.pause = false;\n\n    // connect transport\n    this.subscribe();\n  }\n\n  subscribe() {\n    window.apiCallback = window.apiCallback || {};\n  }\n\n  debug(...args) {\n    if (!this.log) return;\n    console.log(...args);\n  }\n\n  cartCheck(request_id, ignoreCart) {\n    if (!this.pause && (!this.interval || ignoreCart)) {\n      const request = this.requests[request_id];\n      this.sendRequest(request);\n      this.debug('cartCheck', 'call', request);\n      return;\n    }\n    this.debug('cartCheck', 'push');\n    this.cart.push(request_id);\n  }\n\n  cartTick() {\n    this.debug('cartTick', this.cart.length);\n    if (!this.cart.length) {\n      clearInterval(this.interval);\n      delete this.interval;\n      return;\n    }\n    const request_id = this.cart.shift();\n    this.cartCheck(request_id, true);\n  }\n\n  cartInit() {\n    this.debug('cartInit');\n    if (this.interval) return;\n    this.interval = setInterval(() => this.cartTick(), 334);\n  }\n\n  showCaptcha(method, params, error) {\n    if (!this.view) {\n      throw error;\n    }\n\n    this.pause = 1;\n    return new Promise((resolve) => {\n      const view = this.view;\n      const oldPopout = view.state.popout;\n      const { captcha_img } = error;\n      view.setState({\n        popout: (\n          <Alert\n            actionsLayout=\"vertical\"\n            actions={[\n              {\n                title: 'OK',\n                autoclose: true,\n              }\n            ]}\n            onClose={() => {\n              resolve(view.state.captchaCode);\n              view.setState({ popout: oldPopout, captchaCode: null });\n            }}\n          >\n            <h2>Введите код с картинки</h2>\n            <img src={captcha_img} style={{ width: 238, borderRadius: 3 }} alt={captcha_img}/>\n            <Input defaultValue='' onChange={(e) => {\n              const captchaCode = e.currentTarget.value;\n              view.setState({ captchaCode });\n            }}/>\n          </Alert>\n        )\n      });\n    }).then((captcha_key) => {\n      this.pause = 0;\n      const captcha_sid = error.captcha_sid;\n      return this.callMethod(method, {\n        ...params,\n        captcha_key,\n        captcha_sid,\n      });\n    });\n  }\n\n  callMethod = (method, params = {}) => {\n    return new Promise((resolve, reject) => {\n      const request_id = (Math.random() * 1e20).toString(32);\n      const data = {\n        method,\n        params: {\n          access_token: this.access_token,\n          v: this.v,\n          ...params,\n        },\n        request_id,\n      };\n\n      this.requests[request_id] = { resolve, reject, data };\n      this.cartCheck(request_id);\n    }).catch((error) => {\n      error = error || {};\n      const apiError = error.error_reason || error;\n      const errorCode = apiError.error_code || 0;\n\n      switch (errorCode) {\n        case 6:\n          this.cartInit();\n          return this.callMethod(method, params);\n        case 14:\n          return this.showCaptcha(method, params, apiError);\n        default:\n          throw apiError;\n      }\n    });\n  };\n\n  parseError = (data) => {\n    const { error_data, request_id } = data;\n    if (!this.requests[request_id]) return;\n    this.requests[request_id].reject(error_data);\n    delete this.requests[request_id];\n  };\n\n  parseResponse = (data) => {\n    const { response, request_id } = data;\n    if (!this.requests[request_id]) return;\n    this.requests[request_id].resolve(response);\n    delete this.requests[request_id];\n  };\n\n  callback(request_id, callback_name, { error: error_data, response }) {\n    if (error_data) {\n      this.parseError({ error_data, request_id });\n    } else {\n      this.parseResponse({ response, request_id });\n    }\n\n    document.getElementById(callback_name).outerHTML = '';\n    delete window.apiCallback[callback_name];\n  }\n\n  sendJSON(callback_name, method, params) {\n    const script = document.createElement('script');\n    let src = 'https://api.vk.com/method/' + method + '/?';\n\n    params.callback = 'apiCallback.' + callback_name;\n\n    Object.entries(params).forEach(([key, value]) => {\n      value = encodeURIComponent(String(value));\n      src += `&${key}=${value}`;\n    });\n\n    script.id = callback_name;\n    script.src = src;\n\n    script.onerror = (error) => {\n      window.apiCallback[callback_name]({ error });\n    };\n\n    document.head.appendChild(script);\n  }\n\n  sendRequest({ data: { method, params, request_id }}) {\n    const callback_name  = 'fn' + request_id.replace('.', '_');\n\n    window.apiCallback[callback_name] = this.callback.bind(this, request_id, callback_name);\n\n    this.sendJSON(callback_name, method, params);\n  }\n}\n\nexport default JSONP_PromiseAPI;\n"],"file":"JSONP_PromiseAPI.js"}